<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>web.wsgiserver.wsgiserver3 &#8212; BiBler webservice 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for web.wsgiserver.wsgiserver3</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;A high-speed, production ready, thread pooled, generic HTTP server.</span>

<span class="sd">Simplest example on how to use this module directly</span>
<span class="sd">(without using CherryPy&#39;s application machinery)::</span>

<span class="sd">    from cherrypy import wsgiserver</span>

<span class="sd">    def my_crazy_app(environ, start_response):</span>
<span class="sd">        status = &#39;200 OK&#39;</span>
<span class="sd">        response_headers = [(&#39;Content-type&#39;,&#39;text/plain&#39;)]</span>
<span class="sd">        start_response(status, response_headers)</span>
<span class="sd">        return [&#39;Hello world!&#39;]</span>

<span class="sd">    server = wsgiserver.CherryPyWSGIServer(</span>
<span class="sd">                (&#39;0.0.0.0&#39;, 8070), my_crazy_app,</span>
<span class="sd">                server_name=&#39;www.cherrypy.example&#39;)</span>
<span class="sd">    server.start()</span>

<span class="sd">The CherryPy WSGI server can serve as many WSGI applications</span>
<span class="sd">as you want in one instance by using a WSGIPathInfoDispatcher::</span>

<span class="sd">    d = WSGIPathInfoDispatcher({&#39;/&#39;: my_crazy_app, &#39;/blog&#39;: my_blog_app})</span>
<span class="sd">    server = wsgiserver.CherryPyWSGIServer((&#39;0.0.0.0&#39;, 80), d)</span>

<span class="sd">Want SSL support? Just set server.ssl_adapter to an SSLAdapter instance.</span>

<span class="sd">This won&#39;t call the CherryPy engine (application side) at all, only the</span>
<span class="sd">HTTP server, which is independent from the rest of CherryPy. Don&#39;t</span>
<span class="sd">let the name &quot;CherryPyWSGIServer&quot; throw you; the name merely reflects</span>
<span class="sd">its origin, not its coupling.</span>

<span class="sd">For those of you wanting to understand internals of this module, here&#39;s the</span>
<span class="sd">basic call flow. The server&#39;s listening thread runs a very tight loop,</span>
<span class="sd">sticking incoming connections onto a Queue::</span>

<span class="sd">    server = CherryPyWSGIServer(...)</span>
<span class="sd">    server.start()</span>
<span class="sd">    while True:</span>
<span class="sd">        tick()</span>
<span class="sd">        # This blocks until a request comes in:</span>
<span class="sd">        child = socket.accept()</span>
<span class="sd">        conn = HTTPConnection(child, ...)</span>
<span class="sd">        server.requests.put(conn)</span>

<span class="sd">Worker threads are kept in a pool and poll the Queue, popping off and then</span>
<span class="sd">handling each connection in turn. Each connection can consist of an arbitrary</span>
<span class="sd">number of requests and their responses, so we run a nested loop::</span>

<span class="sd">    while True:</span>
<span class="sd">        conn = server.requests.get()</span>
<span class="sd">        conn.communicate()</span>
<span class="sd">        -&gt;  while True:</span>
<span class="sd">                req = HTTPRequest(...)</span>
<span class="sd">                req.parse_request()</span>
<span class="sd">                -&gt;  # Read the Request-Line, e.g. &quot;GET /page HTTP/1.1&quot;</span>
<span class="sd">                    req.rfile.readline()</span>
<span class="sd">                    read_headers(req.rfile, req.inheaders)</span>
<span class="sd">                req.respond()</span>
<span class="sd">                -&gt;  response = app(...)</span>
<span class="sd">                    try:</span>
<span class="sd">                        for chunk in response:</span>
<span class="sd">                            if chunk:</span>
<span class="sd">                                req.write(chunk)</span>
<span class="sd">                    finally:</span>
<span class="sd">                        if hasattr(response, &quot;close&quot;):</span>
<span class="sd">                            response.close()</span>
<span class="sd">                if req.close_connection:</span>
<span class="sd">                    return</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HTTPRequest&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTPConnection&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTPServer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;SizeCheckWrapper&#39;</span><span class="p">,</span> <span class="s1">&#39;KnownLengthRFile&#39;</span><span class="p">,</span> <span class="s1">&#39;ChunkedRFile&#39;</span><span class="p">,</span>
           <span class="s1">&#39;CP_makefile&#39;</span><span class="p">,</span>
           <span class="s1">&#39;MaxSizeExceeded&#39;</span><span class="p">,</span> <span class="s1">&#39;NoSSLError&#39;</span><span class="p">,</span> <span class="s1">&#39;FatalSSLAlert&#39;</span><span class="p">,</span>
           <span class="s1">&#39;WorkerThread&#39;</span><span class="p">,</span> <span class="s1">&#39;ThreadPool&#39;</span><span class="p">,</span> <span class="s1">&#39;SSLAdapter&#39;</span><span class="p">,</span>
           <span class="s1">&#39;CherryPyWSGIServer&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Gateway&#39;</span><span class="p">,</span> <span class="s1">&#39;WSGIGateway&#39;</span><span class="p">,</span> <span class="s1">&#39;WSGIGateway_10&#39;</span><span class="p">,</span> <span class="s1">&#39;WSGIGateway_u0&#39;</span><span class="p">,</span>
           <span class="s1">&#39;WSGIPathInfoDispatcher&#39;</span><span class="p">,</span> <span class="s1">&#39;get_ssl_adapter_class&#39;</span><span class="p">,</span>
           <span class="s1">&#39;socket_errors_to_ignore&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">email.utils</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span> <span class="k">as</span> <span class="nn">traceback_</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="k">import</span> <span class="n">urlparse</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># prefer slower Python-based io module</span>
    <span class="kn">import</span> <span class="nn">_pyio</span> <span class="k">as</span> <span class="nn">io</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Python 2.6</span>
    <span class="kn">import</span> <span class="nn">io</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="s1">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s2">&quot;AF_INET6&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;IPPROTO_IPV6&#39;</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span> <span class="o">=</span> <span class="mi">41</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;IPV6_V6ONLY&#39;</span><span class="p">):</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_V6ONLY</span> <span class="o">=</span> <span class="mi">27</span>


<span class="n">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">DEFAULT_BUFFER_SIZE</span>


<span class="k">try</span><span class="p">:</span>
    <span class="n">cp_version</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s1">&#39;cherrypy&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">version</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">cp_version</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">unicodestr</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ntob</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the given native string as a byte string in the given</span>
<span class="sd">        encoding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In Python 3, the native string type is unicode</span>
        <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">unicodestr</span> <span class="o">=</span> <span class="n">unicode</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="n">basestring</span>

    <span class="k">def</span> <span class="nf">ntob</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the given native string as a byte string in the given</span>
<span class="sd">        encoding.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In Python 2, the native string type is bytes. Assume it&#39;s already</span>
        <span class="c1"># in the given encoding, which for ISO-8859-1 is almost always what</span>
        <span class="c1"># was intended.</span>
        <span class="k">return</span> <span class="n">n</span>

<span class="n">LF</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">CRLF</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">TAB</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">SPACE</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="n">COLON</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
<span class="n">SEMICOLON</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">EMPTY</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">NUMBER_SIGN</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
<span class="n">QUESTION_MARK</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
<span class="n">ASTERISK</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="n">FORWARD_SLASH</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="n">quoted_slash</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">ntob</span><span class="p">(</span><span class="s2">&quot;(?i)</span><span class="si">%2F</span><span class="s2">&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">plat_specific_errors</span><span class="p">(</span><span class="o">*</span><span class="n">errnames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return error numbers for all errors in errnames on this platform.</span>

<span class="sd">    The &#39;errno&#39; module contains different global constants depending on</span>
<span class="sd">    the specific platform (OS). This function will return the list of</span>
<span class="sd">    numeric values for a given list of potential names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errno_names</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">errnames</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">errno_names</span><span class="p">]</span>
    <span class="c1"># de-dupe the list</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="n">socket_error_eintr</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span><span class="s2">&quot;EINTR&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAEINTR&quot;</span><span class="p">)</span>

<span class="n">socket_errors_to_ignore</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span>
    <span class="s2">&quot;EPIPE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EBADF&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAEBADF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ENOTSOCK&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAENOTSOCK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ETIMEDOUT&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAETIMEDOUT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ECONNREFUSED&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAECONNREFUSED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ECONNRESET&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAECONNRESET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ECONNABORTED&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAECONNABORTED&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ENETRESET&quot;</span><span class="p">,</span> <span class="s2">&quot;WSAENETRESET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EHOSTDOWN&quot;</span><span class="p">,</span> <span class="s2">&quot;EHOSTUNREACH&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">socket_errors_to_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;timed out&quot;</span><span class="p">)</span>
<span class="n">socket_errors_to_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;The read operation timed out&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
    <span class="n">socket_errors_to_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plat_specific_errors</span><span class="p">(</span><span class="s2">&quot;EPROTOTYPE&quot;</span><span class="p">))</span>

<span class="n">socket_errors_nonblocking</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span>
    <span class="s1">&#39;EAGAIN&#39;</span><span class="p">,</span> <span class="s1">&#39;EWOULDBLOCK&#39;</span><span class="p">,</span> <span class="s1">&#39;WSAEWOULDBLOCK&#39;</span><span class="p">)</span>

<span class="n">comma_separated_headers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ntob</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span>
    <span class="p">[</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Charset&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Accept-Language&#39;</span><span class="p">,</span> <span class="s1">&#39;Accept-Ranges&#39;</span><span class="p">,</span> <span class="s1">&#39;Allow&#39;</span><span class="p">,</span> <span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;Content-Language&#39;</span><span class="p">,</span> <span class="s1">&#39;Expect&#39;</span><span class="p">,</span>
     <span class="s1">&#39;If-Match&#39;</span><span class="p">,</span> <span class="s1">&#39;If-None-Match&#39;</span><span class="p">,</span> <span class="s1">&#39;Pragma&#39;</span><span class="p">,</span> <span class="s1">&#39;Proxy-Authenticate&#39;</span><span class="p">,</span> <span class="s1">&#39;TE&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Trailer&#39;</span><span class="p">,</span> <span class="s1">&#39;Transfer-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s1">&#39;Vary&#39;</span><span class="p">,</span> <span class="s1">&#39;Via&#39;</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">,</span>
     <span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">]</span>
<span class="p">]</span>


<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="s1">&#39;statistics&#39;</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">read_headers</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="n">hdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read headers from the given stream into the given header dict.</span>

<span class="sd">    If hdict is None, a new header dict is created. Returns the populated</span>
<span class="sd">    header dict.</span>

<span class="sd">    Headers which are repeated are folded together using a comma if their</span>
<span class="sd">    specification so dictates.</span>

<span class="sd">    This function raises ValueError when the read bytes violate the HTTP spec.</span>
<span class="sd">    You should probably return &quot;400 Bad Request&quot; if this happens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="c1"># No more data--illegal end of headers</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal end of headers.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="c1"># Normal end of headers</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">SPACE</span><span class="p">,</span> <span class="n">TAB</span><span class="p">):</span>
            <span class="c1"># It&#39;s a continuation line.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">COLON</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal header line.&quot;</span><span class="p">)</span>
            <span class="c1"># TODO: what about TE and WWW-Authenticate?</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">hname</span> <span class="o">=</span> <span class="n">k</span>

        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comma_separated_headers</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">hdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">existing</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">hdict</span><span class="p">[</span><span class="n">hname</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">hdict</span>


<div class="viewcode-block" id="MaxSizeExceeded"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.MaxSizeExceeded">[docs]</a><span class="k">class</span> <span class="nc">MaxSizeExceeded</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SizeCheckWrapper"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper">[docs]</a><span class="k">class</span> <span class="nc">SizeCheckWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, raising MaxSizeExceeded if too large.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_check_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxSizeExceeded</span><span class="p">()</span>

<div class="viewcode-block" id="SizeCheckWrapper.read"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="SizeCheckWrapper.readline"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="c1"># User didn&#39;t specify a size ...</span>
        <span class="c1"># We read the line in chunks to make sure it&#39;s not a 100MB line !</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># See https://github.com/cherrypy/cherrypy/issues/421</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">LF</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">EMPTY</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="SizeCheckWrapper.readlines"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="SizeCheckWrapper.close"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="SizeCheckWrapper.next"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SizeCheckWrapper.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span></div></div>


<div class="viewcode-block" id="KnownLengthRFile"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.KnownLengthRFile">[docs]</a><span class="k">class</span> <span class="nc">KnownLengthRFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, returning an empty string when exhausted.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">content_length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">content_length</span>

<div class="viewcode-block" id="KnownLengthRFile.read"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.KnownLengthRFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="KnownLengthRFile.readline"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.KnownLengthRFile.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="KnownLengthRFile.readlines"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.KnownLengthRFile.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="KnownLengthRFile.close"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.KnownLengthRFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="ChunkedRFile"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile">[docs]</a><span class="k">class</span> <span class="nc">ChunkedRFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, returning an empty string when exhausted.</span>

<span class="sd">    This class is intended to provide a conforming wsgi.input value for</span>
<span class="sd">    request entities that have been encoded with the &#39;chunked&#39; transfer</span>
<span class="sd">    encoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">EMPTY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">bufsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxSizeExceeded</span><span class="p">(</span><span class="s2">&quot;Request Entity Too Large&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SEMICOLON</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad chunked transfer size: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

<span class="c1">##            if line: chunk_extension = line[0]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Request Entity Too Large&quot;</span><span class="p">)</span>

        <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">chunk</span>

        <span class="n">crlf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crlf</span> <span class="o">!=</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Bad chunked transfer coding (expected &#39;</span><span class="se">\\</span><span class="s2">r</span><span class="se">\\</span><span class="s2">n&#39;, &quot;</span>
                <span class="s2">&quot;got &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ChunkedRFile.read"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">EMPTY</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                    <span class="c1"># EOF</span>
                    <span class="k">return</span> <span class="n">data</span>

            <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span></div>

<div class="viewcode-block" id="ChunkedRFile.readline"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">EMPTY</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                    <span class="c1"># EOF</span>
                    <span class="k">return</span> <span class="n">data</span>

            <span class="n">newline_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">LF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newline_pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">newline_pos</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newline_pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">newline_pos</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">newline_pos</span><span class="p">:]</span></div>

<div class="viewcode-block" id="ChunkedRFile.readlines"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span></div>

<div class="viewcode-block" id="ChunkedRFile.read_trailer_lines"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile.read_trailer_lines">[docs]</a>    <span class="k">def</span> <span class="nf">read_trailer_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot read trailers until the request body has been read.&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># No more data--illegal end of headers</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Illegal end of headers.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Request Entity Too Large&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
                <span class="c1"># Normal end of headers</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">line</span></div>

<div class="viewcode-block" id="ChunkedRFile.close"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ChunkedRFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">line</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span></div>


<div class="viewcode-block" id="HTTPRequest"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest">[docs]</a><span class="k">class</span> <span class="nc">HTTPRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An HTTP Request (and response).</span>

<span class="sd">    A single HTTP connection may consist of multiple request/response pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTPServer object which is receiving this request.&quot;&quot;&quot;</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTPConnection object on which this request connected.&quot;&quot;&quot;</span>

    <span class="n">inheaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;A dict of request headers.&quot;&quot;&quot;</span>

    <span class="n">outheaders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;A list of header tuples to write in the response.&quot;&quot;&quot;</span>

    <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;When True, the request has been parsed and is ready to begin generating</span>
<span class="sd">    the response. When False, signals the calling Connection that the response</span>
<span class="sd">    should not be generated and the connection should close.&quot;&quot;&quot;</span>

    <span class="n">close_connection</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;Signals the calling Connection that the request should close. This does</span>
<span class="sd">    not imply an error! The client and/or server may each request that the</span>
<span class="sd">    connection be closed.&quot;&quot;&quot;</span>

    <span class="n">chunked_write</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;If True, output will be encoded with the &quot;chunked&quot; transfer-coding.</span>

<span class="sd">    This value is set automatically inside send_headers.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">ntob</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">)</span>
        <span class="c1"># Use the lowest-common protocol in case read_request_line errors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">=</span> <span class="s1">&#39;HTTP/1.0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">close_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">chunked_write</span>

<div class="viewcode-block" id="HTTPRequest.parse_request"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.parse_request">[docs]</a>    <span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the next HTTP request start-line and message-headers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">SizeCheckWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_header_size</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_request_line</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">MaxSizeExceeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                <span class="s2">&quot;414 Request-URI Too Long&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The Request-URI sent with the request exceeds the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_request_headers</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">MaxSizeExceeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                <span class="s2">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The headers sent with the request exceed the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HTTPRequest.read_request_line"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.read_request_line">[docs]</a>    <span class="k">def</span> <span class="nf">read_request_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># HTTP/1.1 connections are persistent by default. If a client</span>
        <span class="c1"># requests a page, then idles (leaves the connection open),</span>
        <span class="c1"># then rfile.readline() will raise socket.error(&quot;timed out&quot;).</span>
        <span class="c1"># Note that it does this based on the value given to settimeout(),</span>
        <span class="c1"># and doesn&#39;t need the client to request or acknowledge the close</span>
        <span class="c1"># (although your TCP stack might suffer for it: cf Apache&#39;s history</span>
        <span class="c1"># with FIN_WAIT_2).</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

        <span class="c1"># Set started_request to True so communicate() knows to send 408</span>
        <span class="c1"># from here on out.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">request_line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="c1"># RFC 2616 sec 4.1: &quot;...if the server is reading the protocol</span>
            <span class="c1"># stream at the beginning of a message and receives a CRLF</span>
            <span class="c1"># first, it should ignore the CRLF.&quot;</span>
            <span class="c1"># But only ignore one leading line! else we enable a DoS.</span>
            <span class="n">request_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                <span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="s2">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">req_protocol</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SPACE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="c1"># The [x:y] slicing is necessary for byte strings to avoid getting</span>
            <span class="c1"># ord&#39;s</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_protocol</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_protocol</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="s2">&quot;Malformed Request-Line&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

        <span class="c1"># uri may be an abs_path (including &quot;http://host.domain.tld&quot;);</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_request_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Invalid path in Request-URI.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">NUMBER_SIGN</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;Illegal #fragment in Request-URI.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">scheme</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">EMPTY</span>
        <span class="k">if</span> <span class="n">QUESTION_MARK</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">QUESTION_MARK</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Unquote the path+params (e.g. &quot;/this%20path&quot; -&gt; &quot;/this path&quot;).</span>
        <span class="c1"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2</span>
        <span class="c1">#</span>
        <span class="c1"># But note that &quot;...a URI must be separated into its components</span>
        <span class="c1"># before the escaped characters within those components can be</span>
        <span class="c1"># safely decoded.&quot; http://www.ietf.org/rfc/rfc2396.txt, sec 2.4.2</span>
        <span class="c1"># Therefore, &quot;/this%2Fpath&quot; becomes &quot;/this%2Fpath&quot;, not &quot;/this/path&quot;.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unquote_bytes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">quoted_slash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="si">%2F</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># Note that, like wsgiref and most other HTTP servers,</span>
        <span class="c1"># we &quot;% HEX HEX&quot;-unquote the path but not the query string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span>

        <span class="c1"># Compare request and server HTTP protocol versions, in case our</span>
        <span class="c1"># server does not support the requested protocol. Limit our output</span>
        <span class="c1"># to min(req, server). We want the following output:</span>
        <span class="c1">#     request    server     actual written   supported response</span>
        <span class="c1">#     protocol   protocol  response protocol    feature set</span>
        <span class="c1"># a     1.0        1.0           1.0                1.0</span>
        <span class="c1"># b     1.0        1.1           1.1                1.0</span>
        <span class="c1"># c     1.1        1.0           1.0                1.0</span>
        <span class="c1"># d     1.1        1.1           1.1                1.1</span>
        <span class="c1"># Notice that, in (b), the response will be &quot;HTTP/1.1&quot; even though</span>
        <span class="c1"># the client only understands 1.0. RFC 2616 10.5.6 says we should</span>
        <span class="c1"># only return 505 if the _major_ version is different.</span>
        <span class="c1"># The [x:y] slicing is necessary for byte strings to avoid getting</span>
        <span class="c1"># ord&#39;s</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;505 HTTP Version Not Supported&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">request_protocol</span> <span class="o">=</span> <span class="n">req_protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">=</span> <span class="s2">&quot;HTTP/</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HTTPRequest.read_request_headers"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.read_request_headers">[docs]</a>    <span class="k">def</span> <span class="nf">read_request_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read self.rfile into self.inheaders. Return success.&quot;&quot;&quot;</span>

        <span class="c1"># then all the http headers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">mrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_body_size</span>
        <span class="k">if</span> <span class="n">mrbs</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">mrbs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                <span class="s2">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                <span class="s2">&quot;The entity sent with the request exceeds the maximum &quot;</span>
                <span class="s2">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Persistent connection support</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="c1"># Both server and client are HTTP/1.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;close&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Either the server or client (or both) are HTTP/1.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;Keep-Alive&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Transfer-Encoding support</span>
        <span class="n">te</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Transfer-Encoding&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">te</span><span class="p">:</span>
                <span class="n">te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">te</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">te</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">te</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enc</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;chunked&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Note that, even if we see &quot;chunked&quot;, we must reject</span>
                    <span class="c1"># if there is an extension we don&#39;t recognize.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;501 Unimplemented&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># From PEP 333:</span>
        <span class="c1"># &quot;Servers and gateways that implement HTTP 1.1 must provide</span>
        <span class="c1"># transparent support for HTTP 1.1&#39;s &quot;expect/continue&quot; mechanism.</span>
        <span class="c1"># This may be done in any of several ways:</span>
        <span class="c1">#   1. Respond to requests containing an Expect: 100-continue request</span>
        <span class="c1">#      with an immediate &quot;100 Continue&quot; response, and proceed normally.</span>
        <span class="c1">#   2. Proceed with the request normally, but provide the application</span>
        <span class="c1">#      with a wsgi.input stream that will send the &quot;100 Continue&quot;</span>
        <span class="c1">#      response if/when the application first attempts to read from</span>
        <span class="c1">#      the input stream. The read request must then remain blocked</span>
        <span class="c1">#      until the client responds.</span>
        <span class="c1">#   3. Wait until the client decides that the server does not support</span>
        <span class="c1">#      expect/continue, and sends the request body on its own.</span>
        <span class="c1">#      (This is suboptimal, and is not recommended.)</span>
        <span class="c1">#</span>
        <span class="c1"># We used to do 3, but are now doing 1. Maybe we&#39;ll do 2 someday,</span>
        <span class="c1"># but it seems like it would be a big slowdown for such a rare case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Expect&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;100-continue&quot;</span><span class="p">:</span>
            <span class="c1"># Don&#39;t use simple_response here, because it emits headers</span>
            <span class="c1"># we don&#39;t want. See</span>
            <span class="c1"># https://github.com/cherrypy/cherrypy/issues/951</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot; 100 Continue</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HTTPRequest.parse_request_uri"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.parse_request_uri">[docs]</a>    <span class="k">def</span> <span class="nf">parse_request_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a Request-URI into (scheme, authority, path).</span>

<span class="sd">        Note that Request-URI&#39;s must be one of::</span>

<span class="sd">            Request-URI    = &quot;*&quot; | absoluteURI | abs_path | authority</span>

<span class="sd">        Therefore, a Request-URI which starts with a double forward-slash</span>
<span class="sd">        cannot be a &quot;net_path&quot;::</span>

<span class="sd">            net_path      = &quot;//&quot; authority [ abs_path ]</span>

<span class="sd">        Instead, it must be interpreted as an &quot;abs_path&quot; with an empty first</span>
<span class="sd">        path segment::</span>

<span class="sd">            abs_path      = &quot;/&quot;  path_segments</span>
<span class="sd">            path_segments = segment *( &quot;/&quot; segment )</span>
<span class="sd">            segment       = *pchar *( &quot;;&quot; param )</span>
<span class="sd">            param         = *pchar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="o">==</span> <span class="n">ASTERISK</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uri</span>

        <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">and</span> <span class="n">QUESTION_MARK</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">scheme</span><span class="p">:</span>
            <span class="c1"># An absoluteURI.</span>
            <span class="c1"># If there&#39;s a scheme (and it must be http or https), then:</span>
            <span class="c1"># http_URL = &quot;http:&quot; &quot;//&quot; host [ &quot;:&quot; port ] [ abs_path [ &quot;?&quot; query</span>
            <span class="c1"># ]]</span>
            <span class="k">return</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span>

        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">FORWARD_SLASH</span><span class="p">):</span>
            <span class="c1"># An abs_path.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An authority.</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="HTTPRequest.unquote_bytes"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.unquote_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">unquote_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;takes quoted string and unquotes % encoded values&quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">)])</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="HTTPRequest.respond"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the gateway and write its iterable output.&quot;&quot;&quot;</span>
        <span class="n">mrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_body_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">ChunkedRFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">mrbs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">mrbs</span> <span class="ow">and</span> <span class="n">mrbs</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                        <span class="s2">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;The entity sent with the request exceeds the &quot;</span>
                        <span class="s2">&quot;maximum allowed bytes.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">KnownLengthRFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">respond</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_headers</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;0</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HTTPRequest.simple_response"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.simple_response">[docs]</a>    <span class="k">def</span> <span class="nf">simple_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a simple response back to the client.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">SPACE</span> <span class="o">+</span>
               <span class="nb">bytes</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">,</span>
               <span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;Content-Length: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">),</span>
               <span class="sa">b</span><span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">status</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;413&quot;</span><span class="p">,</span> <span class="s2">&quot;414&quot;</span><span class="p">):</span>
            <span class="c1"># Request Entity Too Large / Request-URI Too Long</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.1&#39;</span><span class="p">:</span>
                <span class="c1"># This will not be true for 414, since read_request_line</span>
                <span class="c1"># usually raises 414 before reading the whole line, and we</span>
                <span class="c1"># therefore cannot know the proper response_protocol.</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Connection: close</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># HTTP/1.0 had no 413/414 status nor Connection header.</span>
                <span class="c1"># Emit 400 instead and trust the message body is enough.</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;400 Bad Request&quot;</span>

        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">unicodestr</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="HTTPRequest.write"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write unbuffered data to the client.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="ow">and</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bytes</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)),</span> <span class="s1">&#39;ASCII&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">CRLF</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">CRLF</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">EMPTY</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span></div>

<div class="viewcode-block" id="HTTPRequest.send_headers"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPRequest.send_headers">[docs]</a>    <span class="k">def</span> <span class="nf">send_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assert, process, and send the HTTP response message-headers.</span>

<span class="sd">        You must set self.status, and self.outheaders before calling this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">413</span><span class="p">:</span>
            <span class="c1"># Request Entity Too Large. Close conn to avoid garbage.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;content-length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="c1"># &quot;All 1xx (informational), 204 (no content),</span>
            <span class="c1"># and 304 (not modified) responses MUST NOT</span>
            <span class="c1"># include a message-body.&quot; So no point chunking.</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">304</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.1&#39;</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;HEAD&#39;</span><span class="p">):</span>
                    <span class="c1"># Use the chunked transfer-coding</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s2">&quot;Transfer-Encoding&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;chunked&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Closing the conn is the only way to determine len.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;connection&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s1">&#39;HTTP/1.1&#39;</span><span class="p">:</span>
                <span class="c1"># Both server and client are HTTP/1.1 or better</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;close&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Server and/or client are HTTP/1.0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">b</span><span class="s2">&quot;Connection&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;Keep-Alive&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span><span class="p">):</span>
            <span class="c1"># Read any remaining request body data on the socket.</span>
            <span class="c1"># &quot;If an origin server receives a request that does not include an</span>
            <span class="c1"># Expect request-header field with the &quot;100-continue&quot; expectation,</span>
            <span class="c1"># the request includes a request body, and the server responds</span>
            <span class="c1"># with a final status code before reading the entire request body</span>
            <span class="c1"># from the transport connection, then the server SHOULD NOT close</span>
            <span class="c1"># the transport connection until it has read the entire request,</span>
            <span class="c1"># or until the client closes the connection. Otherwise, the client</span>
            <span class="c1"># might not reliably receive the response message. However, this</span>
            <span class="c1"># requirement is not be construed as preventing a server from</span>
            <span class="c1"># defending itself against denial-of-service attacks, or from</span>
            <span class="c1"># badly broken client implementations.&quot;</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="s1">&#39;remaining&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>

        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="sa">b</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">formatdate</span><span class="p">(</span><span class="n">usegmt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">if</span> <span class="sa">b</span><span class="s2">&quot;server&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)))</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
            <span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">COLON</span> <span class="o">+</span> <span class="n">SPACE</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">EMPTY</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="NoSSLError"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.NoSSLError">[docs]</a><span class="k">class</span> <span class="nc">NoSSLError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Exception raised when a client speaks HTTP to an HTTPS socket.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="FatalSSLAlert"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.FatalSSLAlert">[docs]</a><span class="k">class</span> <span class="nc">FatalSSLAlert</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Exception raised when the SSL implementation signals a fatal alert.&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">CP_BufferedWriter</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedWriter</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Faux file object attached to a socket object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkClosed</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;can&#39;t write str to binary stream&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_buf</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flush_unlocked</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_flush_unlocked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkClosed</span><span class="p">(</span><span class="s2">&quot;flush of closed file&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buf</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># ssl sockets only except &#39;bytes&#39;, not bytearrays</span>
                <span class="c1"># so perhaps we should conditionally wrap this for perf?</span>
                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_buf</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">io</span><span class="o">.</span><span class="n">BlockingIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">characters_written</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_buf</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>


<div class="viewcode-block" id="CP_makefile"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.CP_makefile">[docs]</a><span class="k">def</span> <span class="nf">CP_makefile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">BufferedReader</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SocketIO</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">bufsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CP_BufferedWriter</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SocketIO</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mode</span><span class="p">),</span> <span class="n">bufsize</span><span class="p">)</span></div>


<div class="viewcode-block" id="HTTPConnection"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPConnection">[docs]</a><span class="k">class</span> <span class="nc">HTTPConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An HTTP connection (active socket).</span>

<span class="sd">    server: the Server object which received this connection.</span>
<span class="sd">    socket: the raw socket object (usually TCP) for this connection.</span>
<span class="sd">    makefile: a fileobject class for reading from the socket.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">remote_addr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">remote_port</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ssl_env</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rbufsize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFFER_SIZE</span>
    <span class="n">wbufsize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFFER_SIZE</span>
    <span class="n">RequestHandlerClass</span> <span class="o">=</span> <span class="n">HTTPRequest</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">makefile</span><span class="o">=</span><span class="n">CP_makefile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">makefile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">makefile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wbufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="HTTPConnection.communicate"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPConnection.communicate">[docs]</a>    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read each request and respond appropriately.&quot;&quot;&quot;</span>
        <span class="n">request_seen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># (re)set req to None so that if something goes wrong in</span>
                <span class="c1"># the RequestHandlerClass constructor, the error doesn&#39;t</span>
                <span class="c1"># get written to the previous request.</span>
                <span class="n">req</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestHandlerClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

                <span class="c1"># This order of operations should guarantee correct pipelining.</span>
                <span class="n">req</span><span class="o">.</span><span class="n">parse_request</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="c1"># Something went wrong in the parsing (and the server has</span>
                    <span class="c1"># probably already made a simple_response). Return and</span>
                    <span class="c1"># let the conn close.</span>
                    <span class="k">return</span>

                <span class="n">request_seen</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">req</span><span class="o">.</span><span class="n">respond</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">errnum</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># sadly SSL sockets return a different (longer) time out string</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">errnum</span> <span class="o">==</span> <span class="s1">&#39;timed out&#39;</span> <span class="ow">or</span>
                <span class="n">errnum</span> <span class="o">==</span> <span class="s1">&#39;The read operation timed out&#39;</span>
            <span class="p">):</span>
                <span class="c1"># Don&#39;t error if we&#39;re between requests; only error</span>
                <span class="c1"># if 1) no request has been started at all, or 2) we&#39;re</span>
                <span class="c1"># in the middle of a request.</span>
                <span class="c1"># See https://github.com/cherrypy/cherrypy/issues/853</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">request_seen</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">req</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">started_request</span><span class="p">):</span>
                    <span class="c1"># Don&#39;t bother writing the 408 if the response</span>
                    <span class="c1"># has already started being written.</span>
                    <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;408 Request Timeout&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                            <span class="c1"># Close the connection.</span>
                            <span class="k">return</span>
            <span class="k">elif</span> <span class="n">errnum</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_log</span><span class="p">(</span><span class="s2">&quot;socket.error </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">errnum</span><span class="p">),</span>
                                      <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;500 Internal Server Error&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                        <span class="c1"># Close the connection.</span>
                        <span class="k">return</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
            <span class="c1"># Close the connection.</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">NoSSLError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="c1"># Unwrap our wfile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">CP_makefile</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">_sock</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wbufsize</span><span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span>
                    <span class="s2">&quot;400 Bad Request&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;The client sent a plain HTTP request, but this server &quot;</span>
                    <span class="s2">&quot;only speaks HTTPS on this port.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linger</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">error_log</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;500 Internal Server Error&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                    <span class="c1"># Close the connection.</span>
                    <span class="k">return</span></div>

    <span class="n">linger</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="HTTPConnection.close"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPConnection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the socket underlying this connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">linger</span><span class="p">:</span>
            <span class="c1"># Python&#39;s socket module does NOT call close on the kernel</span>
            <span class="c1"># socket when you call socket.close(). We do so manually here</span>
            <span class="c1"># because we want this server to send a FIN TCP segment</span>
            <span class="c1"># immediately. Note this must be called *before* calling</span>
            <span class="c1"># socket.close(), because the latter drops its reference to</span>
            <span class="c1"># the kernel socket.</span>
            <span class="c1"># Python 3 *probably* fixed this with socket._real_close;</span>
            <span class="c1"># hard to tell.</span>
<span class="c1"># self.socket._sock.close()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On the other hand, sometimes we want to hang around for a bit</span>
            <span class="c1"># to make sure the client has a chance to read our entire</span>
            <span class="c1"># response. Skipping the close() calls here delays the FIN</span>
            <span class="c1"># packet until the socket object is garbage-collected later.</span>
            <span class="c1"># Someday, perhaps, we&#39;ll do the full lingering_close that</span>
            <span class="c1"># Apache does, but not today.</span>
            <span class="k">pass</span></div></div>


<span class="k">class</span> <span class="nc">TrueyZero</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An object which equals and does math like the integer 0 but evals True.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">other</span>
<span class="n">trueyzero</span> <span class="o">=</span> <span class="n">TrueyZero</span><span class="p">()</span>


<span class="n">_SHUTDOWNREQUEST</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="WorkerThread"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WorkerThread">[docs]</a><span class="k">class</span> <span class="nc">WorkerThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Thread which continuously polls a Queue for Connection objects.</span>

<span class="sd">    Due to the timing issues of polling a Queue, a WorkerThread does not</span>
<span class="sd">    check its own &#39;ready&#39; flag after it has started. To stop the thread,</span>
<span class="sd">    it is necessary to stick a _SHUTDOWNREQUEST object onto the Queue</span>
<span class="sd">    (one for each running WorkerThread).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The current connection pulled off the Queue, or None.&quot;&quot;&quot;</span>

    <span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTP Server which spawned this thread, and which owns the</span>
<span class="sd">    Queue and is placing active connections into it.&quot;&quot;&quot;</span>

    <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;A simple flag for the calling server to know when this thread</span>
<span class="sd">    has begun polling the Queue.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Requests&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">trueyzero</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">requests_seen</span>
            <span class="p">),</span>
            <span class="s1">&#39;Bytes Read&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">trueyzero</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">bytes_read</span>
            <span class="p">),</span>
            <span class="s1">&#39;Bytes Written&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">trueyzero</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">bytes_written</span>
            <span class="p">),</span>
            <span class="s1">&#39;Work Time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">trueyzero</span> <span class="ow">or</span>
                <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
            <span class="p">),</span>
            <span class="s1">&#39;Read Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">),</span>
            <span class="s1">&#39;Write Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="WorkerThread.run"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WorkerThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="n">_SHUTDOWNREQUEST</span><span class="p">:</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">requests_seen</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">bytes_read</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">bytes_written</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">exc</span></div></div>


<div class="viewcode-block" id="ThreadPool"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool">[docs]</a><span class="k">class</span> <span class="nc">ThreadPool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A Request Queue for an HTTPServer which pools threads.</span>

<span class="sd">    ThreadPool objects must provide min, get(), put(obj), start()</span>
<span class="sd">    and stop(timeout) attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">accepted_queue_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">accepted_queue_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="nb">min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">accepted_queue_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_put_timeout</span> <span class="o">=</span> <span class="n">accepted_queue_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span>

<div class="viewcode-block" id="ThreadPool.start"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the pool of threads.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WorkerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;CP Server &quot;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of worker threads which are idle. Read-only.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span>
    <span class="n">idle</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_idle</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_get_idle</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadPool.put"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue_put_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">_SHUTDOWNREQUEST</span><span class="p">:</span>
            <span class="k">return</span></div>

<div class="viewcode-block" id="ThreadPool.grow"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool.grow">[docs]</a>    <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn new worker threads (not above self.max).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">budget</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.max &lt;= 0 indicates no maximum</span>
            <span class="n">budget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">n_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">budget</span><span class="p">)</span>

        <span class="n">workers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_spawn_worker</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_new</span><span class="p">)]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">ready</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">workers</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_spawn_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">WorkerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s2">&quot;CP Server &quot;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
        <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">worker</span>

<div class="viewcode-block" id="ThreadPool.shrink"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool.shrink">[docs]</a>    <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kill off worker threads (not below self.min).&quot;&quot;&quot;</span>
        <span class="c1"># Grow/shrink the pool if necessary.</span>
        <span class="c1"># Remove any dead threads from our list</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">amount</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="c1"># calculate the number of threads above the minimum</span>
        <span class="n">n_extra</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># don&#39;t remove more than amount</span>
        <span class="n">n_to_remove</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">n_extra</span><span class="p">)</span>

        <span class="c1"># put shutdown requests on the queue equal to the number of threads</span>
        <span class="c1"># to remove. As each request is processed by a worker, that worker</span>
        <span class="c1"># will terminate and be culled from the list.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_to_remove</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_SHUTDOWNREQUEST</span><span class="p">)</span></div>

<div class="viewcode-block" id="ThreadPool.stop"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.ThreadPool.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c1"># Must shut down threads here so the code that calls</span>
        <span class="c1"># this method can know when all threads are stopped.</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_SHUTDOWNREQUEST</span><span class="p">)</span>

        <span class="c1"># Don&#39;t join currentThread (when stop is called inside a request).</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">endtime</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">remaining_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remaining_time</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                            <span class="c1"># We exhausted the timeout.</span>
                            <span class="c1"># Forcibly shut down the socket.</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">conn</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RD</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                    <span class="c1"># pyOpenSSL sockets don&#39;t take an arg</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span>
                        <span class="c1"># Ignore repeated Ctrl-C.</span>
                        <span class="c1"># See</span>
                        <span class="c1"># https://github.com/cherrypy/cherrypy/issues/691.</span>
                        <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
                    <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_get_qsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
    <span class="n">qsize</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_qsize</span><span class="p">)</span></div>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="n">windll</span><span class="p">,</span> <span class="n">WinError</span>
        <span class="kn">import</span> <span class="nn">ctypes.wintypes</span>
        <span class="n">_SetHandleInformation</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">SetHandleInformation</span>
        <span class="n">_SetHandleInformation</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">HANDLE</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">_SetHandleInformation</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Dummy function, since neither fcntl nor ctypes are available.&quot;&quot;&quot;</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Mark the given socket fd as non-inheritable (Windows).&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_SetHandleInformation</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">WinError</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the given socket fd as non-inheritable (POSIX).&quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">old_flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
        <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">old_flags</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">)</span>


<div class="viewcode-block" id="SSLAdapter"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SSLAdapter">[docs]</a><span class="k">class</span> <span class="nc">SSLAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Base class for SSL driver library adapters.</span>

<span class="sd">    Required methods:</span>

<span class="sd">        * ``wrap(sock) -&gt; (wrapped socket, ssl environ dict)``</span>
<span class="sd">        * ``makefile(sock, mode=&#39;r&#39;, bufsize=DEFAULT_BUFFER_SIZE) -&gt;</span>
<span class="sd">          socket file object``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">certificate_chain</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate_chain</span> <span class="o">=</span> <span class="n">certificate_chain</span>

<div class="viewcode-block" id="SSLAdapter.wrap"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SSLAdapter.wrap">[docs]</a>    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="SSLAdapter.makefile"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.SSLAdapter.makefile">[docs]</a>    <span class="k">def</span> <span class="nf">makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span></div></div>


<div class="viewcode-block" id="HTTPServer"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer">[docs]</a><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;An HTTP server.&quot;&quot;&quot;</span>

    <span class="n">_bind_addr</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
    <span class="n">_interrupt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">gateway</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;A Gateway instance.&quot;&quot;&quot;</span>

    <span class="n">minthreads</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The minimum number of worker threads to create (default 10).&quot;&quot;&quot;</span>

    <span class="n">maxthreads</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The maximum number of worker threads to create (default -1 = no limit).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">server_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The name of the server; defaults to socket.gethostname().&quot;&quot;&quot;</span>

    <span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;HTTP/1.1&quot;</span>
    <span class="sd">&quot;&quot;&quot;The version string to write in the Status-Line of all HTTP responses.</span>

<span class="sd">    For example, &quot;HTTP/1.1&quot; is the default. This also limits the supported</span>
<span class="sd">    features used in the response.&quot;&quot;&quot;</span>

    <span class="n">request_queue_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;The &#39;backlog&#39; arg to socket.listen(); max queued connections</span>
<span class="sd">    (default 5).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shutdown_timeout</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;The total time, in seconds, to wait for worker threads to cleanly exit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="sd">&quot;&quot;&quot;The timeout in seconds for accepted connections (default 10).&quot;&quot;&quot;</span>

    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;CherryPy/&quot;</span> <span class="o">+</span> <span class="n">cp_version</span>
    <span class="sd">&quot;&quot;&quot;A version string for the HTTPServer.&quot;&quot;&quot;</span>

    <span class="n">software</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;The value to set for the SERVER_SOFTWARE entry in the WSGI environ.</span>

<span class="sd">    If None, this defaults to ``&#39;%s Server&#39; % self.version``.&quot;&quot;&quot;</span>

    <span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="sd">&quot;&quot;&quot;An internal flag which marks whether the socket is accepting</span>
<span class="sd">    connections.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_request_header_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;The maximum size, in bytes, for request headers, or 0 for no limit.&quot;&quot;&quot;</span>

    <span class="n">max_request_body_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;The maximum size, in bytes, for request bodies, or 0 for no limit.&quot;&quot;&quot;</span>

    <span class="n">nodelay</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="sd">&quot;&quot;&quot;If True (the default since 3.1), sets the TCP_NODELAY socket option.&quot;&quot;&quot;</span>

    <span class="n">ConnectionClass</span> <span class="o">=</span> <span class="n">HTTPConnection</span>
    <span class="sd">&quot;&quot;&quot;The class to use for handling HTTP connections.&quot;&quot;&quot;</span>

    <span class="n">ssl_adapter</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;An instance of SSLAdapter (or a subclass).</span>

<span class="sd">    You must have the corresponding SSL driver library installed.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_addr</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span> <span class="n">minthreads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxthreads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">server_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">=</span> <span class="n">bind_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">gateway</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">minthreads</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">maxthreads</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_name</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_stats</span><span class="p">()</span>

<div class="viewcode-block" id="HTTPServer.clear_stats"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.clear_stats">[docs]</a>    <span class="k">def</span> <span class="nf">clear_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;Bind Address&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">),</span>
            <span class="s1">&#39;Run time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">(),</span>
            <span class="s1">&#39;Accepts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;Accepts/sec&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Accepts&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">(),</span>
            <span class="s1">&#39;Queue&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;qsize&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;Threads&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;_threads&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s1">&#39;Threads Idle&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;Socket Errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;Requests&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Requests&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Bytes Read&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Bytes Written&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Work Time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Read Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Write Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="s1">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;Worker Threads&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">statistics</span><span class="p">[</span><span class="s2">&quot;CherryPy HTTPServer </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span></div>

<div class="viewcode-block" id="HTTPServer.runtime"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_bind_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind_addr</span>

    <span class="k">def</span> <span class="nf">_set_bind_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Despite the socket module docs, using &#39;&#39; does not</span>
            <span class="c1"># allow AI_PASSIVE to work. Passing None instead</span>
            <span class="c1"># returns &#39;0.0.0.0&#39; like we want. In other words:</span>
            <span class="c1">#     host    AI_PASSIVE     result</span>
            <span class="c1">#      &#39;&#39;         Y         192.168.x.y</span>
            <span class="c1">#      &#39;&#39;         N         192.168.x.y</span>
            <span class="c1">#     None        Y         0.0.0.0</span>
            <span class="c1">#     None        N         127.0.0.1</span>
            <span class="c1"># But since you can get the same effect with an explicit</span>
            <span class="c1"># &#39;0.0.0.0&#39;, we deny both the empty string and None as values.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Host values of &#39;&#39; or None are not allowed. &quot;</span>
                             <span class="s2">&quot;Use &#39;0.0.0.0&#39; (IPv4) or &#39;::&#39; (IPv6) instead &quot;</span>
                             <span class="s2">&quot;to listen on all active interfaces.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind_addr</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">bind_addr</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">_get_bind_addr</span><span class="p">,</span>
        <span class="n">_set_bind_addr</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The interface on which to listen for connections.</span>

<span class="s2">        For TCP sockets, a (host, port) tuple. Host values may be any IPv4</span>
<span class="s2">        or IPv6 address, or any valid hostname. The string &#39;localhost&#39; is a</span>
<span class="s2">        synonym for &#39;127.0.0.1&#39; (or &#39;::1&#39;, if your hosts file prefers IPv6).</span>
<span class="s2">        The string &#39;0.0.0.0&#39; is a special IPv4 entry meaning &quot;any active</span>
<span class="s2">        interface&quot; (INADDR_ANY), and &#39;::&#39; is the similar IN6ADDR_ANY for</span>
<span class="s2">        IPv6. The empty string or None are not allowed.</span>

<span class="s2">        For UNIX sockets, supply the filename as a string.&quot;&quot;&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="HTTPServer.start"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the server forever.&quot;&quot;&quot;</span>
        <span class="c1"># We don&#39;t have to trap KeyboardInterrupt or SystemExit here,</span>
        <span class="c1"># because cherrpy.server already does so, calling self.stop() for us.</span>
        <span class="c1"># If you&#39;re using this server with another framework, you should</span>
        <span class="c1"># trap those exceptions in whatever code block calls start().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Server&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>

        <span class="c1"># Select the appropriate socket</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="c1"># AF_UNIX socket</span>

            <span class="c1"># So we can reuse the socket...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># So everyone can access the socket...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">info</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># AF_INET or AF_INET6 socket</span>
            <span class="c1"># Get the correct address family for our host (allows IPv6</span>
            <span class="c1"># addresses)</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No socket could be created&quot;</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -- (</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Timeout so KeyboardInterrupt can be caught on Win32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span><span class="p">)</span>

        <span class="c1"># Create worker threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_log</span><span class="p">(</span><span class="s2">&quot;Error in HTTPServer.tick&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
                               <span class="n">traceback</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># Wait for self.stop() to complete. See _set_interrupt.</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span></div>

<div class="viewcode-block" id="HTTPServer.error_log"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.error_log">[docs]</a>    <span class="k">def</span> <span class="nf">error_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Override this in subclasses as desired</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">traceback</span><span class="p">:</span>
            <span class="n">tblines</span> <span class="o">=</span> <span class="n">traceback_</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tblines</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="HTTPServer.bind"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.bind">[docs]</a>    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create (or recreate) the actual socket object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
        <span class="n">prevent_socket_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelay</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>

        <span class="c1"># If listening on the IPV6 any address (&#39;::&#39; = IN6ADDR_ANY),</span>
        <span class="c1"># activate dual-stack. See</span>
        <span class="c1"># https://github.com/cherrypy/cherrypy/issues/871.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;AF_INET6&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="s1">&#39;::0&#39;</span><span class="p">,</span> <span class="s1">&#39;::0.0.0.0&#39;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span>
                    <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_V6ONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>
                <span class="c1"># Apparently, the socket option is not available in</span>
                <span class="c1"># this machine&#39;s TCP stack</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span></div>

<div class="viewcode-block" id="HTTPServer.tick"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accept a new connection and put it on the Queue.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Accepts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">prevent_socket_inheritance</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;settimeout&#39;</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">makefile</span> <span class="o">=</span> <span class="n">CP_makefile</span>
            <span class="n">ssl_env</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># if ssl cert and key are set, we try to be a secure HTTP server</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">ssl_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">NoSSLError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The client sent a plain HTTP request, but &quot;</span>
                           <span class="s2">&quot;this server only speaks HTTPS on this port.&quot;</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> 400 Bad Request</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                           <span class="s2">&quot;Content-Length: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
                           <span class="s2">&quot;Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">,</span>
                           <span class="n">msg</span><span class="p">]</span>

                    <span class="n">wfile</span> <span class="o">=</span> <span class="n">makefile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">wfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">makefile</span>
                <span class="c1"># Re-apply our timeout since we may have a new socket object</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;settimeout&#39;</span><span class="p">):</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConnectionClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="c1"># optional values</span>
                <span class="c1"># Until we do DNS lookups, omit REMOTE_HOST</span>
                <span class="k">if</span> <span class="n">addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># sometimes this can happen</span>
                    <span class="c1"># figure out if AF_INET or AF_INET6.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># AF_INET</span>
                        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># AF_INET6</span>
                        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">remote_port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span> <span class="o">=</span> <span class="n">ssl_env</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Full</span><span class="p">:</span>
                <span class="c1"># Just drop the conn. TODO: write 503 back?</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c1"># The only reason for the timeout in start() is so we can</span>
            <span class="c1"># notice keyboard interrupts on Win32, which don&#39;t interrupt</span>
            <span class="c1"># accept() by default</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Enabled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;Socket Errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_error_eintr</span><span class="p">:</span>
                <span class="c1"># I *think* this is right. EINTR should occur when a signal</span>
                <span class="c1"># is received during the accept() call; all docs say retry</span>
                <span class="c1"># the call, and I *think* I&#39;m reading it right that Python</span>
                <span class="c1"># will then go ahead and poll for and handle the signal</span>
                <span class="c1"># elsewhere. See</span>
                <span class="c1"># https://github.com/cherrypy/cherrypy/issues/707.</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_errors_nonblocking</span><span class="p">:</span>
                <span class="c1"># Just try again. See</span>
                <span class="c1"># https://github.com/cherrypy/cherrypy/issues/479.</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="c1"># Our socket was closed.</span>
                <span class="c1"># See https://github.com/cherrypy/cherrypy/issues/686.</span>
                <span class="k">return</span>
            <span class="k">raise</span></div>

    <span class="k">def</span> <span class="nf">_get_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span>

    <span class="k">def</span> <span class="nf">_set_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_interrupt</span><span class="p">,</span> <span class="n">_set_interrupt</span><span class="p">,</span>
                         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Set this to an Exception instance to &quot;</span>
                             <span class="s2">&quot;interrupt the server.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="HTTPServer.stop"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.HTTPServer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gracefully shutdown a server that is serving forever.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sock</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;socket&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="c1"># Touch our own socket to make accept() return immediately.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                        <span class="c1"># Changed to use error code and not message</span>
                        <span class="c1"># See</span>
                        <span class="c1"># https://github.com/cherrypy/cherrypy/issues/860.</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Note that we&#39;re explicitly NOT using AI_PASSIVE,</span>
                    <span class="c1"># here, because we want an actual IP to touch.</span>
                    <span class="c1"># localhost won&#39;t work if we&#39;ve bound to a public IP,</span>
                    <span class="c1"># but it will if we bound to &#39;0.0.0.0&#39; (INADDR_ANY).</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
                                                  <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
                        <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                            <span class="c1"># See</span>
                            <span class="c1"># http://groups.google.com/group/cherrypy-users/</span>
                            <span class="c1">#     browse_frm/thread/bbfe5eb39c904fe0</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Gateway"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.Gateway">[docs]</a><span class="k">class</span> <span class="nc">Gateway</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A base class to interface HTTPServer with other systems, such as WSGI.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>

<div class="viewcode-block" id="Gateway.respond"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.Gateway.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the current request. Must be overridden in a subclass.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span></div></div>


<span class="c1"># These may either be wsgiserver.SSLAdapter subclasses or the string names</span>
<span class="c1"># of such classes (in which case they will be lazily loaded).</span>
<span class="n">ssl_adapters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;builtin&#39;</span><span class="p">:</span> <span class="s1">&#39;cherrypy.wsgiserver.ssl_builtin.BuiltinSSLAdapter&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pyopenssl&#39;</span><span class="p">:</span> <span class="s1">&#39;cherrypy.wsgiserver.ssl_pyopenssl.pyOpenSSLAdapter&#39;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="get_ssl_adapter_class"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.get_ssl_adapter_class">[docs]</a><span class="k">def</span> <span class="nf">get_ssl_adapter_class</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;builtin&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an SSL adapter class for the given name.&quot;&quot;&quot;</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">ssl_adapters</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="n">last_dot</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">[</span><span class="n">last_dot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">mod_path</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">[:</span><span class="n">last_dot</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod_path</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># The last [&#39;&#39;] is important.</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mod_path</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>

        <span class="c1"># Let an AttributeError propagate outward.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">mod_path</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">adapter</span></div>

<span class="c1"># ------------------------------- WSGI Stuff -------------------------------- #</span>


<div class="viewcode-block" id="CherryPyWSGIServer"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.CherryPyWSGIServer">[docs]</a><span class="k">class</span> <span class="nc">CherryPyWSGIServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A subclass of HTTPServer which calls a WSGI application.&quot;&quot;&quot;</span>

    <span class="n">wsgi_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;The version of WSGI to produce.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_addr</span><span class="p">,</span> <span class="n">wsgi_app</span><span class="p">,</span> <span class="n">numthreads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">server_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="nb">max</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">request_queue_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shutdown_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">accepted_queue_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">accepted_queue_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">numthreads</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span>
            <span class="n">accepted_queue_size</span><span class="o">=</span><span class="n">accepted_queue_size</span><span class="p">,</span>
            <span class="n">accepted_queue_timeout</span><span class="o">=</span><span class="n">accepted_queue_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">wsgi_app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">wsgi_gateways</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wsgi_version</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">=</span> <span class="n">bind_addr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_name</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span> <span class="o">=</span> <span class="n">request_queue_size</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span> <span class="o">=</span> <span class="n">shutdown_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_stats</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_numthreads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">min</span>

    <span class="k">def</span> <span class="nf">_set_numthreads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">numthreads</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_numthreads</span><span class="p">,</span> <span class="n">_set_numthreads</span><span class="p">)</span></div>


<div class="viewcode-block" id="WSGIGateway"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway</span><span class="p">(</span><span class="n">Gateway</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A base class to interface HTTPServer with WSGI.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="WSGIGateway.get_environ"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span></div>

<div class="viewcode-block" id="WSGIGateway.respond"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the current request.&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="c1"># &quot;The start_response callable must not actually transmit</span>
                <span class="c1"># the response headers. Instead, it must store them for the</span>
                <span class="c1"># server or gateway to transmit only after the first</span>
                <span class="c1"># iteration of the application return value that yields</span>
                <span class="c1"># a NON-EMPTY string, or upon the application&#39;s first</span>
                <span class="c1"># invocation of the write() callable.&quot; (PEP 333)</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="n">unicodestr</span><span class="p">):</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="WSGIGateway.start_response"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway.start_response">[docs]</a>    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WSGI callable to begin the HTTP response.&quot;&quot;&quot;</span>
        <span class="c1"># &quot;The application may call start_response more than once,</span>
        <span class="c1"># if and only if the exc_info argument is provided.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;WSGI start_response called a second &quot;</span>
                                 <span class="s2">&quot;time with no exc_info.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># &quot;if exc_info is provided, and the HTTP headers have already been</span>
        <span class="c1"># sent, start_response must raise an error, and should raise the</span>
        <span class="c1"># exc_info tuple.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># According to PEP 3333, when using Python 3, the response status</span>
        <span class="c1"># and headers must be bytes masquerading as unicode; that is, they</span>
        <span class="c1"># must be of type &quot;str&quot; but are restricted to code points in the</span>
        <span class="c1"># &quot;latin-1&quot; set.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;WSGI response status is not of type str.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;WSGI response header key </span><span class="si">%r</span><span class="s2"> is not of type str.&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;WSGI response header value </span><span class="si">%r</span><span class="s2"> is not of type str.&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span> <span class="n">v</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span></div>

<div class="viewcode-block" id="WSGIGateway.write"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WSGI callable to write unbuffered data to the client.</span>

<span class="sd">        This method is also used internally by start_response (to write</span>
<span class="sd">        data from the iterable returned by the WSGI application).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;WSGI write called before start_response.&quot;</span><span class="p">)</span>

        <span class="n">chunklen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">rbo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span>
        <span class="k">if</span> <span class="n">rbo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chunklen</span> <span class="o">&gt;</span> <span class="n">rbo</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="c1"># Whew. We can send a 500 to the client.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s2">&quot;500 Internal Server Error&quot;</span><span class="p">,</span>
                                         <span class="s2">&quot;The requested resource returned &quot;</span>
                                         <span class="s2">&quot;more bytes than the declared &quot;</span>
                                         <span class="s2">&quot;Content-Length.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Dang. We have probably already sent data. Truncate the chunk</span>
                <span class="c1"># to fit (so the client doesn&#39;t hang) and raise an error later.</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">rbo</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">send_headers</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rbo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rbo</span> <span class="o">-=</span> <span class="n">chunklen</span>
            <span class="k">if</span> <span class="n">rbo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Response body exceeds the declared Content-Length.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WSGIGateway_10"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway_10">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway_10</span><span class="p">(</span><span class="n">WSGIGateway</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A Gateway class to interface HTTPServer with WSGI 1.0.x.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WSGIGateway_10.get_environ"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway_10.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># set a non-standard environ entry so the WSGI app can know what</span>
            <span class="c1"># the *real* server protocol is (and what features to support).</span>
            <span class="c1"># See http://www.faqs.org/rfcs/rfc2145.html.</span>
            <span class="s1">&#39;ACTUAL_SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="s1">&#39;PATH_INFO&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;QUERY_STRING&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">remote_addr</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;REMOTE_PORT&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">remote_port</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;REQUEST_METHOD&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SERVER_NAME&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span><span class="p">,</span>
            <span class="c1"># Bah. &quot;SERVER_PROTOCOL&quot; is actually the REQUEST protocol.</span>
            <span class="s1">&#39;SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">request_protocol</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;SERVER_SOFTWARE&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.errors&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.input&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.multiprocess&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.multithread&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.run_once&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;wsgi.url_scheme&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;wsgi.version&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="c1"># AF_UNIX. This isn&#39;t really allowed by WSGI, which doesn&#39;t</span>
            <span class="c1"># address unix domain sockets. But it&#39;s better than nothing.</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;SERVER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;SERVER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Request headers</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;HTTP_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ISO-8859-1&#39;</span><span class="p">)</span>

        <span class="c1"># CONTENT_TYPE/CONTENT_LENGTH</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;HTTP_CONTENT_TYPE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;CONTENT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;HTTP_CONTENT_LENGTH&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;CONTENT_LENGTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span>

        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">env</span></div></div>


<div class="viewcode-block" id="WSGIGateway_u0"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway_u0">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway_u0</span><span class="p">(</span><span class="n">WSGIGateway_10</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A Gateway class to interface HTTPServer with WSGI u.0.</span>

<span class="sd">    WSGI u.0 is an experimental protocol, which uses unicode for keys</span>
<span class="sd">    and values in both Python 2 and Python 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WSGIGateway_u0.get_environ"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIGateway_u0.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span>
        <span class="n">env_10</span> <span class="o">=</span> <span class="n">WSGIGateway_10</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">env_10</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Request-URI</span>
        <span class="n">env</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;wsgi.url_encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># SCRIPT_NAME is the empty string, who cares what encoding it is?</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.url_encoding&#39;</span><span class="p">])</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;QUERY_STRING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">qs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.url_encoding&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="c1"># Fall back to latin 1 so apps can transcode if needed.</span>
            <span class="n">env</span><span class="p">[</span><span class="s1">&#39;wsgi.url_encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ISO-8859-1&#39;</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_10</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span>
            <span class="n">env</span><span class="p">[</span><span class="s2">&quot;QUERY_STRING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_10</span><span class="p">[</span><span class="s2">&quot;QUERY_STRING&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">env</span></div></div>

<span class="n">wsgi_gateways</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">WSGIGateway_10</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">WSGIGateway_u0</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="WSGIPathInfoDispatcher"><a class="viewcode-back" href="../../../web.wsgiserver.html#web.wsgiserver.wsgiserver3.WSGIPathInfoDispatcher">[docs]</a><span class="k">class</span> <span class="nc">WSGIPathInfoDispatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A WSGI dispatcher for dispatch based on the PATH_INFO.</span>

<span class="sd">    apps: a dict or list of (path_prefix, app) pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">apps</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Sort the apps by len(path), descending</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="c1"># The path_prefix strings must start, but not end, with a slash.</span>
        <span class="c1"># Use &quot;&quot; instead of &quot;/&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;/&quot;</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="c1"># The apps list should be sorted by length, descending.</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SCRIPT_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SCRIPT_NAME&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span>
                <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">):]</span>
                <span class="k">return</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Félix Bélanger-Robillard.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>